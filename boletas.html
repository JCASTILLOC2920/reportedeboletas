<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JC PATH LAB - Generador de Boletas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/dexie@3.2.2/dist/dexie.js"></script>
    <!-- Incluir jsPDF desde CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
        :root{--primary:#1a3a5f;--secondary:#2c5d8c;--accent:#3a86b8;--light:#f8f9fa;--dark:#0d1b2a;--text:#333333;--border:#e0e0e0;--success:#4caf50;--hover:#2a7cc7;--light-blue:#3a86b8;--pending:#e74c3c;}
        body{background-color:#f5f7fa;color:var(--text);display:flex;min-height:100vh;}
        header{background:linear-gradient(135deg, var(--primary), var(--secondary));color:white;width:250px;flex-shrink:0;box-shadow:4px 0 12px rgba(0,0,0,0.1);position:relative;z-index:1000;height:100vh;position:fixed;left:0;top:0;overflow-y:auto;}
        .header-container{display:flex;flex-direction:column;padding:1rem 0;height:auto;}
        .logo-section{display:flex;flex-direction:column;align-items:center;cursor:pointer;padding:1rem;text-align:center;margin-bottom:2rem;}
        .logo{width:80px;height:80px;background:linear-gradient(45deg, var(--accent), #4a9bd9);border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,0.2);}
        .logo i{font-size:36px;color:white;}
        .title{font-size:1.2rem;font-weight:600;line-height:1.3;}
        .title span{display:block;font-size:0.85rem;font-weight:400;opacity:0.9;margin-top:5px;}
        nav{width:100%;}
        .nav-menu{display:flex;flex-direction:column;list-style:none;padding:0;width:100%;}
        .nav-menu li{margin:0;position:relative;width:100%;}
        .nav-menu li a{color:white;text-decoration:none;font-weight:500;font-size:1rem;padding:1rem 1.5rem;display:block;transition:all 0.3s ease;position:relative;width:100%;}
        .nav-menu li a:hover{background-color:rgba(255,255,255,0.1);color:#cce6ff;}
        .nav-menu li a::after{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:white;transition:height 0.3s ease;opacity:0;}
        .nav-menu li a:hover::after,.nav-menu li a.active::after{opacity:1;height:100%;}
        .hamburger{display:none;cursor:pointer;background:transparent;border:none;width:40px;height:40px;position:fixed;top:15px;left:15px;z-index:1001;}
        .hamburger span{display:block;width:25px;height:3px;background:var(--primary);margin:5px auto;transition:all 0.3s ease;}
        .main-content{flex:1;margin-left:250px;width:calc(100% - 250px);}
        @media (max-width:860px){body{flex-direction:column;}header{width:100%;height:auto;position:relative;padding:0;}.header-container{height:70px;flex-direction:row;justify-content:space-between;align-items:center;padding:0 1rem;}.logo-section{flex-direction:row;padding:0;margin-bottom:0;}.logo{width:50px;height:50px;margin-right:10px;margin-bottom:0;}.title{font-size:1rem;}.title span{font-size:0.75rem;}.nav-menu{position:fixed;top:0;left:-100%;width:280px;height:100vh;background:linear-gradient(135deg, var(--primary), var(--dark));flex-direction:column;padding:100px 0 30px 0;transition:all 0.5s ease;z-index:1000;box-shadow:5px 0 15px rgba(0,0,0,0.15);}.nav-menu.active{left:0;}.nav-menu li{margin:0;}.nav-menu li a{font-size:1.1rem;padding:1rem 2rem;}.hamburger{display:block;}.hamburger.active span:nth-child(1){transform:translateY(8px) rotate(45deg);}.hamburger.active span:nth-child(2){opacity:0;}.hamburger.active span:nth-child(3){transform:translateY(-8px) rotate(-45deg);}.main-content{margin-left:0;width:100%;}}
        @media (max-width:480px){.header-container{padding:0 1rem;}.title{font-size:0.9rem;}.title span{font-size:0.7rem;}}
        .content{max-width:1200px;margin:3rem auto;padding:0 2rem;text-align:center;}
        .content h1{color:var(--primary);margin-bottom:1.5rem;font-size:2.5rem;}
        .content p{font-size:1.1rem;line-height:1.7;color:#555;max-width:800px;margin:0 auto 2rem;}
        .features{display:flex;flex-wrap:wrap;justify-content:center;gap:2rem;margin-top:3rem;}
        .feature-card{background:white;border-radius:10px;padding:2rem;width:280px;box-shadow:0 5px 15px rgba(0,0,0,0.05);transition:transform 0.3s ease,box-shadow 0.3s ease;}
        .feature-card:hover{transform:translateY(-10px);box-shadow:0 8px 25px rgba(0,0,0,0.1);}
        .feature-card i{font-size:2.5rem;color:var(--accent);margin-bottom:1.5rem;}
        .feature-card h3{color:var(--primary);margin-bottom:1rem;}
        .page-section{display:none;max-width:1200px;margin:3rem auto;padding:0 2rem;}
        .page-section.active{display:block;}
        .section-title{color:var(--primary);margin-bottom:2rem;font-size:2.2rem;text-align:center;border-bottom:2px solid var(--accent);padding-bottom:0.5rem;display:inline-block;}
        .form-container{background:white;border-radius:10px;padding:2.5rem;box-shadow:0 5px 25px rgba(0,0,0,0.08);max-width:800px;margin:0 auto;}
        .form-group{margin-bottom:1.8rem;text-align:left;}
        .form-group label{display:block;margin-bottom:0.5rem;font-weight:600;color:var(--dark);}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:0.8rem 1rem;border:1px solid var(--border);border-radius:6px;font-size:1rem;transition:border-color 0.3s ease;}
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(58,134,184,0.2);}
        .form-row{display:flex;gap:1.5rem;margin-bottom:1.8rem;}
        .form-row .form-group{flex:1;margin-bottom:0;}
        .btn{background:linear-gradient(135deg, var(--accent), var(--secondary));color:white;border:none;border-radius:6px;padding:0.9rem 2rem;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:inline-block;text-align:center;}
        .btn:hover{background:linear-gradient(135deg, var(--secondary), var(--primary));transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15);}
        .btn-block{display:block;width:100%;}
        .table-container{background:white;border-radius:10px;padding:2rem;box-shadow:0 5px 25px rgba(0,0,0,0.08);overflow-x:auto;}
        table{width:100%;border-collapse:collapse;min-width:800px;}
        th{background-color:var(--primary);color:white;text-align:left;padding:1rem;font-weight:600;}
        td{padding:1rem;border-bottom:1px solid var(--border);}
        tr:nth-child(even){background-color:#f9fafb;}
        tr:hover{background-color:#f0f7ff;}
        .a4-container{width:210mm;min-height:297mm;margin:0 auto;background:white;box-shadow:0 5px 25px rgba(0,0,0,0.08);position:relative;padding:15mm;box-sizing:border-box;}
        .template-preview{background:white;border-radius:0;padding:0;border:1px solid var(--border);min-height:267mm;position:relative;}
        .template-header{background:linear-gradient(135deg, var(--primary), var(--secondary));color:white;padding:10mm 15mm;text-align:center;margin:-15mm -15mm 5mm -15mm;}
        .template-body{padding:5mm 0;}
        .template-row{display:flex;border-bottom:1px dashed var(--border);padding:5px 0;margin-bottom:3mm;}
        .template-label{flex:0 0 40%;font-weight:600;color:var(--dark);}
        .template-value{flex:1;}
        .boleta-title{font-family:Arial,sans-serif;font-size:24px;font-weight:bold;text-transform:uppercase;text-decoration:underline;margin:10mm 0 5mm 0;color:var(--light-blue);text-align:center;}
        .location-date{position:absolute;bottom:15mm;right:15mm;font-size:14px;color:#666;font-style:italic;}
        .costo-input{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;margin-bottom:5px;}
        .costo-item{margin-bottom:10px;}
        .total-container{background-color:#f8f9fa;padding:10px;border-radius:4px;margin-top:15px;font-weight:bold;text-align:right;border-left:4px solid var(--accent);margin-bottom: 25mm;} /* Añadido margen inferior para evitar superposición */
        @media print{body *{visibility:hidden;}.a4-container,.a4-container *{visibility:visible;}.a4-container{position:absolute;left:0;top:0;width:210mm;height:297mm;margin:0;padding:15mm;box-shadow:none;page-break-after:always;}.template-header{-webkit-print-color-adjust:exact;color-adjust:exact;}.no-print{display:none !important;}}
        .boleta-pending{border-bottom:2px solid var(--pending) !important;}
        .cancelado-cell{text-align:center;}
        .delete-boleta{background-color:#e74c3c;color:white;border:none;border-radius:4px;padding:5px 10px;cursor:pointer;font-size:0.9rem;margin-left:5px;}
        .delete-boleta:hover{background-color:#c0392b;}
        .print-boleta{background-color:var(--accent);color:white;border:none;border-radius:4px;padding:5px 10px;cursor:pointer;font-size:0.9rem;}
        .print-boleta:hover{background-color:var(--secondary);}
        .action-buttons{display:flex;justify-content:center;}
        .pagination{display:flex;justify-content:center;margin-top:20px;gap:10px;}
        .pagination-btn{background:var(--accent);color:white;border:none;border-radius:4px;padding:8px 15px;cursor:pointer;font-size:0.9rem;}
        .pagination-btn:disabled{background:#ccc;cursor:not-allowed;}
        .page-info{display:flex;align-items:center;font-size:0.9rem;}
        .backup-status{position:fixed;bottom:20px;right:20px;background:var(--dark);color:white;padding:10px 15px;border-radius:5px;font-size:0.8rem;z-index:1000;box-shadow:0 3px 10px rgba(0,0,0,0.2);display:none;}
        .backup-status.success{background:var(--success);}
        .backup-status.error{background:var(--pending);}
        /* Nuevos estilos para centrar el botón */
        .centered-button {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        /* Estilos para mensajes de error */
        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: none;
        }
        .form-group.error input {
            border-color: #e74c3c;
        }
    </style>
</head>
<body style="overflow:auto;">
    <header>
        <div class="header-container">
            <div class="logo-section" id="logoSection">
                <div class="logo"><i class="fas fa-microscope"></i></div>
                <div class="title">JC PATH LAB<span>Generador de Boletas de Laboratorio de Anatomía Patológica</span></div>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li><a href="#" class="nav-link active" data-section="registro">Registro de cliente</a></li>
                    <li><a href="#" class="nav-link" data-section="listado">Listado de clientes</a></li>
                    <li><a href="#" class="nav-link" data-section="plantilla">Plantilla de boleta</a></li>
                    <li><a href="#" class="nav-link" data-section="registro-boletas">Registro de boletas</a></li>
                </ul>
                <button class="hamburger"><span></span><span></span><span></span></button>
            </nav>
        </div>
    </header>

    <div class="main-content">
        <section class="content" id="inicio" style="display:none;">
            <h1>Sistema de Gestión de Laboratorio de Anatomía Patológica</h1>
            <p>JC PATH LAB ofrece soluciones avanzadas para la generación de boletas de laboratorio, gestión de clientes y seguimiento de muestras patológicas con los más altos estándares de calidad.</p>
            
            <div class="features">
                <div class="feature-card"><i class="fas fa-user-plus"></i><h3>Registro de Clientes</h3><p>Gestión completa de información de clientes y pacientes con historial de muestras.</p></div>
                <div class="feature-card"><i class="fas fa-list-alt"></i><h3>Listado de Clientes</h3><p>Acceso rápido a todos los clientes registrados dengan opciones de búsqueda avanzada.</p></div>
                <div class="feature-card"><i class="fas fa-file-medical"></i><h3>Plantillas de Boletas</h3><p>Generación profesional de boletas con diseños personalizables y datos precisos.</p></div>
                <div class="feature-card"><i class="fas fa-receipt"></i><h3>Registro de Boletas</h3><p>Gestión permanente de boletas generadas con seguimiento de pagos y estado.</p></div>
                <div class="feature-card"><i class="fas fa-users"></i><h3>Usuarios del Sistema</h3><p>Gestión de usuarios y permisos del sistema administrativo.</p></div>
            </div>
        </section>

        <section class="page-section" id="registro" style="display:block;">
            <div class="form-container">
                <h2 class="section-title">Registro de Cliente</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="razon-social">Razón Social</label>
                        <input type="text" id="razon-social" placeholder="Ingrese razón social">
                        <div class="error-message" id="razon-social-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="ruc">RUC</label>
                        <input type="text" id="ruc" placeholder="Número de RUC">
                        <div class="error-message" id="ruc-error"></div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="direccion">Dirección</label>
                        <input type="text" id="direccion" placeholder="Dirección completa">
                        <div class="error-message" id="direccion-error"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="telefono">Teléfono</label>
                        <input type="text" id="telefono" placeholder="Número de teléfono">
                        <div class="error-message" id="telefono-error"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="Correo electrónico">
                    <div class="error-message" id="email-error"></div>
                </div>
                
                <button class="btn btn-block" id="registrar-cliente">Registrar Cliente</button>
            </div>
        </section>

        <section class="page-section" id="listado" style="display:none;">
            <div class="table-container">
                <h2 class="section-title">Listado de Clientes</h2>
                
                <table id="clientes-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Razón Social</th>
                            <th>RUC</th>
                            <th>Dirección</th>
                            <th>Teléfono</th>
                            <th>Email</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="clientes-body"></tbody>
                </table>
                
                <div class="pagination" id="clientes-pagination">
                    <button class="pagination-btn" id="prev-clientes" disabled>Anterior</button>
                    <div class="page-info">Página <span id="clientes-page">1</span></div>
                    <button class="pagination-btn" id="next-clientes">Siguiente</button>
                </div>
            </div>
        </section>

        <section class="page-section" id="plantilla" style="display:none;">
            <div class="a4-container">
                <div class="template-preview">
                    <div class="template-header">
                        <h2>JC PATH LAB</h2>
                        <p>Laboratorio de Anatomía Patológica</p>
                    </div>
                    <div class="boleta-title">BOLETA DE VENTA</div>
                    
                    <div class="template-body">
                        <div class="template-row">
                            <div class="template-label">EMISOR:</div>
                            <div class="template-value"></div>
                        </div>
                        
                        <div class="template-row">
                            <div class="template-label">NOMBRE:</div>
                            <div class="template-value">Josehp Christopher Castillo Cuenca</div>
                        </div>
                        
                        <div class="template-row">
                            <div class="template-label">DOCUMENTO:</div>
                            <div class="template-value">DNI 41457466</div>
                        </div>
                        
                        <div class="template-row">
                            <div class="template-label">DIRECCIÓN:</div>
                            <div class="template-value">MZ M2 LOTE 13 URB. JARDINES DE CHILLON</div>
                        </div>
                        
                        <div class="template-row">
                            <div class="template-label">RUC Emisor:</div>
                            <div class="template-value">10414574667</div>
                        </div>
                        
                        <div class="template-row" style="border-bottom:2px solid var(--border);margin:10mm 0;"></div>
                        
                        <div class="template-row">
                            <div class="template-label" style="font-size:1.2em;color:var(--primary);">CLIENTE:</div>
                            <div class="template-value"></div>
                        </div>
                        
                        <div class="template-row">
                            <div class="template-label">Razón Social:</div>
                            <div class="template-value">
                                <select id="cliente-select" class="costo-input"><option value="">Seleccione un cliente</option></select>
                            </div>
                        </div>
                        
                        <div class="template-row">
                            <div class="template-label">RUC:</div>
                            <div class="template-value" id="ruc-cliente"></div>
                        </div>
                        
                        <div class="template-row">
                            <div class="template-label">Dirección:</div>
                            <div class="template-value" id="direccion-cliente"></div>
                        </div>
                        
                        <div class="template-row">
                            <div class="template-label">Número de muestras:</div>
                            <div class="template-value">
                                <input type="number" id="num-muestras" min="1" value="1" class="costo-input">
                            </div>
                        </div>
                        
                        <div id="costos-container"><div class="template-row costo-item">
                            <div class="template-label">Muestra 1 Costo:</div>
                            <div class="template-value">
                                <input type="number" class="costo-input costo-muestra" min="0" step="0.01" placeholder="S/ 0.00" data-index="1">
                            </div>
                        </div></div>
                        
                        <div class="total-container">
                            <div class="template-label">Pago total:</div>
                            <div class="template-value" id="pago-total">S/ 0.00</div>
                        </div>
                    </div>
                    
                    <div class="location-date">Puente Piedra, <span id="current-date">17 de agosto de 2025</span></div>
                </div>
            </div>
            
            <div class="no-print centered-button"> <!-- Cambiado a clase centered-button -->
                <button class="btn" id="guardar-boleta"><i class="fas fa-save"></i> Guardar Boleta</button>
            </div>
        </section>
        
        <section class="page-section" id="registro-boletas" style="display:none;">
            <div class="table-container">
                <h2 class="section-title">Registro de Boletas</h2>
                <p class="section-description" style="text-align:center;margin-bottom:20px;color:#555;">Este registro permanece permanente y solo puede ser eliminado por el administrador</p>
                
                <table id="boletas-table">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Razón Social</th>
                            <th>RUC</th>
                            <th>Dirección</th>
                            <th>N° Muestras</th>
                            <th>Monto</th>
                            <th>Cancelado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="boletas-body"></tbody>
                </table>
                
                <div class="pagination" id="boletas-pagination">
                    <button class="pagination-btn" id="prev-boletas" disabled>Anterior</button>
                    <div class="page-info">Página <span id="boletas-page">1</span></div>
                    <button class="pagination-btn" id="next-boletas">Siguiente</button>
                </div>
            </div>
        </section>

        <section class="page-section" id="usuarios-sistema" style="display:none;">
            <div class="form-container">
                <h2 class="section-title">Usuarios del Sistema</h2>
                <p style="text-align:center;margin-bottom:30px;">Gestión de usuarios y permisos del sistema administrativo</p>
                
                <div class="form-group">
                    <label for="nombre-usuario">Nombre de Usuario</label>
                    <input type="text" id="nombre-usuario" placeholder="Ingrese nombre de usuario">
                </div>
                
                <div class="form-group">
                    <label for="email-usuario">Email</label>
                    <input type="email" id="email-usuario" placeholder="Correo electrónico del usuario">
                </div>
                
                <div class="form-group">
                    <label for="rol-usuario">Rol</label>
                    <select id="rol-usuario" class="costo-input">
                        <option value="">Seleccione un rol</option>
                        <option value="administrador">Administrador</option>
                        <option value="usuario">Usuario</option>
                        <option value="consulta">Consulta</option>
                    </select>
                </div>
                
                <button class="btn btn-block" id="guardar-usuario">Guardar Usuario</button>
            </div>
        </section>
    </div>

    <div id="backup-status" class="backup-status"></div>

    <script>
        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;

        // Variables globales optimizadas
        let db, currentClientPage = 1, currentBoletaPage = 1, totalClientPages = 1, totalBoletaPages = 1;
        const PAGE_SIZE = 10;
        
        // Inicialización optimizada de la base de datos
        async function initDatabase() {
            try {
                db = new Dexie('LaboratorioDB');
                db.version(4).stores({  // Incrementamos la versión para evitar conflictos
                    clientes: '++id, &ruc, razonSocial, direccion, telefono, email, createdAt',
                    boletas: '++id, codigo, razonSocial, ruc, direccion, numMuestras, montos, total, cancelado, fecha, createdAt',
                    configuracion: '++id, clave, valor'
                });
                await db.open();
                if (navigator.storage && navigator.storage.persist) {
                    await navigator.storage.persist();
                }
                return true;
            } catch (error) {
                console.error('Error al inicializar la base de datos:', error);
                try {
                    await Dexie.delete('LaboratorioDB');
                    db = new Dexie('LaboratorioDB');
                    db.version(4).stores({
                        clientes: '++id, &ruc, razonSocial, direccion, telefono, email, createdAt',
                        boletas: '++id, codigo, razonSocial, ruc, direccion, numMuestras, montos, total, cancelado, fecha, createdAt',
                        configuracion: '++id, clave, valor'
                    });
                    await db.open();
                    return true;
                } catch (recreateError) {
                    console.error('Error al recrear la base de datos:', recreateError);
                    alert('Error crítico: No se pudo inicializar la base de datos.');
                    return false;
                }
            }
        }
        
        // Función para mostrar estado de respaldo
        function mostrarEstadoRespaldo(mensaje, tipo) {
            const elemento = document.getElementById('backup-status');
            elemento.textContent = mensaje;
            elemento.className = 'backup-status ' + (tipo || '');
            elemento.style.display = 'block';
            setTimeout(() => { elemento.style.display = 'none'; }, 3000);
        }
        
        // Sistema de respaldo y restauración optimizado
        async function hacerRespaldoCompleto() {
            try {
                const [clientes, boletas] = await Promise.all([
                    db.clientes.toArray(),
                    db.boletas.toArray()
                ]);
                
                const datosRespaldo = { clientes, boletas, fecha: new Date().toISOString() };
                localStorage.setItem('labRespaldoCompleto', JSON.stringify(datosRespaldo));
                localStorage.setItem('labUltimoRespaldo', new Date().toISOString());
                mostrarEstadoRespaldo('Respaldo completado', 'success');
                return true;
            } catch (error) {
                console.error('Error al hacer respaldo completo:', error);
                mostrarEstadoRespaldo('Error en respaldo', 'error');
                return false;
            }
        }
        
        async function restaurarDesdeRespaldo() {
            try {
                const respaldo = localStorage.getItem('labRespaldoCompleto');
                if (!respaldo) return false;
                
                const datosRespaldo = JSON.parse(respaldo);
                const [clientesCount, boletasCount] = await Promise.all([
                    db.clientes.count(),
                    db.boletas.count()
                ]);
                
                if (clientesCount === 0 && boletasCount === 0) {
                    await Promise.all([
                        db.clientes.bulkAdd(datosRespaldo.clientes),
                        db.boletas.bulkAdd(datosRespaldo.boletas)
                    ]);
                    mostrarEstadoRespaldo('Datos restaurados', 'success');
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error al restaurar desde respaldo:', error);
                mostrarEstadoRespaldo('Error al restaurar', 'error');
                return false;
            }
        }
        
        // Precarga de datos críticos optimizada
        async function precargarDatos() {
            try {
                if (!db || !db.isOpen()) {
                    const initialized = await initDatabase();
                    if (!initialized) return;
                }
                
                await restaurarDesdeRespaldo();
                
                const [countClientes, countBoletas] = await Promise.all([
                    db.clientes.count(),
                    db.boletas.count()
                ]);
                
                totalClientPages = Math.ceil(countClientes / PAGE_SIZE);
                totalBoletaPages = Math.ceil(countBoletas / PAGE_SIZE);
                
                updatePagination('clientes');
                updatePagination('boletas');
                
                await Promise.all([
                    renderClientesTable(),
                    renderBoletasTable(),
                    populateClientSelect()
                ]);
                
                await hacerRespaldoCompleto();
            } catch (error) {
                console.error('Error en precarga de datos:', error);
            }
        }
        
        // Escuchador de cambios optimizado
        function setupDatabaseListeners() {
            const backupData = () => hacerRespaldoCompleto().catch(console.error);
            
            const tableHooks = (table, renderFunc, extraFunc) => {
                table.hook('creating', () => setTimeout(() => { renderFunc(); extraFunc && extraFunc(); backupData(); }, 100));
                table.hook('updating', () => setTimeout(() => { renderFunc(); extraFunc && extraFunc(); backupData(); }, 100));
                table.hook('deleting', () => setTimeout(() => { renderFunc(); extraFunc && extraFunc(); backupData(); }, 100));
            };
            
            tableHooks(db.clientes, renderClientesTable, populateClientSelect);
            tableHooks(db.boletas, renderBoletasTable);
        }
        
        // Mobile menu toggle
        const hamburger = document.querySelector('.hamburger');
        const navMenu = document.querySelector('.nav-menu');
        
        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
            document.body.style.overflow = navMenu.classList.contains('active') ? 'hidden' : 'auto';
        });
        
        // Función para mostrar una sección específica
        function showSection(sectionId) {
            const sections = ['inicio', 'registro', 'listado', 'plantilla', 'registro-boletas', 'usuarios-sistema'];
            sections.forEach(id => {
                document.getElementById(id).style.display = id === sectionId ? 'block' : 'none';
            });
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.section === sectionId);
            });
            
            hamburger.classList.remove('active');
            navMenu.classList.remove('active');
            document.body.style.overflow = 'auto';
            
            if (sectionId === 'plantilla') populateClientSelect();
            if (sectionId === 'listado') renderClientesTable();
            if (sectionId === 'registro-boletas') renderBoletasTable();
        }
        
        // Función para formatear fecha
        function formatDate(date) {
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('es-ES', options);
        }
        
        // Función para generar código de boleta
        function generarCodigoBoleta() {
            const currentYear = new Date().getFullYear();
            return `${currentYear}-${new Date().getTime().toString().slice(-5)}`;
        }
        
        // Poblar select de clientes
                async function populateClientSelect() {
            const select = document.getElementById('cliente-select');
            select.innerHTML = '<option value="">Seleccione un cliente</option>';
            
            try {
                const clientes = await getClients(); // Obtener clientes de Google Sheets
                clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.rowIndex; // Usamos rowIndex como ID
                    option.textContent = cliente['Razón Social'];
                    option.setAttribute('data-ruc', cliente['RUC']);
                    option.setAttribute('data-direccion', cliente['Dirección']);
                    option.setAttribute('data-telefono', cliente['Teléfono']);
                    option.setAttribute('data-email', cliente['Email']);
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar clientes para select:', error);
            }
        }
        
        // Renderizar tabla de clientes con paginación
        async function renderClientesTable() {
            const tbody = document.getElementById('clientes-body');
            tbody.innerHTML = '';
            
            try {
                const offset = (currentClientPage - 1) * PAGE_SIZE;
                const clientes = await db.clientes
                    .orderBy('createdAt')
                    .reverse()
                    .offset(offset)
                    .limit(PAGE_SIZE)
                    .toArray();
                
                if (clientes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No hay clientes registrados</td></tr>';
                    return;
                }
                
                clientes.forEach(cliente => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', cliente.id);
                    row.innerHTML = `
                        <td>${cliente.id}</td>
                        <td>${cliente.razonSocial}</td>
                        <td>${cliente.ruc}</td>
                        <td>${cliente.direccion}</td>
                        <td>${cliente.telefono}</td>
                        <td>${cliente.email}</td>
                        <td><button class="btn eliminar-btn">Eliminar</button></td>
                    `;
                    tbody.appendChild(row);
                });
                
                await updatePagination('clientes');
            } catch (error) {
                console.error('Error al cargar clientes:', error);
            }
        }
        
        // Renderizar tabla de boletas con paginación
        async function renderBoletasTable() {
            const tbody = document.getElementById('boletas-body');
            tbody.innerHTML = '';
            
            try {
                const offset = (currentBoletaPage - 1) * PAGE_SIZE;
                const boletas = await db.boletas
                    .orderBy('fecha')
                    .reverse()
                    .offset(offset)
                    .limit(PAGE_SIZE)
                    .toArray();
                
                if (boletas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No hay boletas registradas</td></tr>';
                    return;
                }
                
                boletas.forEach(boleta => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', boleta.id);
                    if (!boleta.cancelado) row.classList.add('boleta-pending');
                    
                    row.innerHTML = `
                        <td>${boleta.codigo}</td>
                        <td>${boleta.razonSocial}</td>
                        <td>${boleta.ruc}</td>
                        <td>${boleta.direccion}</td>
                        <td>${boleta.numMuestras}</td>
                        <td>S/ ${boleta.total.toFixed(2)}</td>
                        <td class="cancelado-cell">
                            <input type="checkbox" ${boleta.cancelado ? 'checked' : ''} 
                                   class="cancelado-checkbox" data-id="${boleta.id}">
                        </td>
                        <td class="action-buttons">
                            <button class="print-boleta" data-id="${boleta.id}">
                                <i class="fas fa-print"></i> Imprimir
                            </button>
                            <button class="delete-boleta" data-id="${boleta.id}">Eliminar</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error al cargar boletas:', error);
            }
        }
        
        // Actualizar paginación
        async function updatePagination(type) {
            try {
                let count, currentPage, totalPages, pageElement;
                
                if (type === 'clientes') {
                    count = await db.clientes.count();
                    totalPages = Math.ceil(count / PAGE_SIZE);
                    currentPage = currentClientPage;
                    pageElement = document.getElementById('clientes-page');
                    document.getElementById('prev-clientes').disabled = currentPage <= 1;
                    document.getElementById('next-clientes').disabled = currentPage >= totalPages;
                } else {
                    count = await db.boletas.count();
                    totalPages = Math.ceil(count / PAGE_SIZE);
                    currentPage = currentBoletaPage;
                    pageElement = document.getElementById('boletas-page');
                    document.getElementById('prev-boletas').disabled = currentPage <= 1;
                    document.getElementById('next-boletas').disabled = currentPage >= totalPages;
                }
                
                pageElement.textContent = currentPage;
            } catch (error) {
                console.error('Error al actualizar paginación:', error);
            }
        }
        
        // Calcular total
        function calcularTotal() {
            let total = 0;
            document.querySelectorAll('.costo-muestra').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            document.getElementById('pago-total').textContent = `S/ ${total.toFixed(2)}`;
        }
        
        // Función para mostrar errores de validación
        function mostrarError(campoId, mensaje) {
            const campo = document.getElementById(campoId);
            const errorElement = document.getElementById(`${campoId}-error`);
            
            campo.classList.add('error');
            errorElement.textContent = mensaje;
            errorElement.style.display = 'block';
        }
        
        // Función para limpiar errores de validación
        function limpiarErrores() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.form-group.error').forEach(el => {
                el.classList.remove('error');
            });
        }
        
        // Función para validar formulario de cliente
        function validarFormularioCliente(razonSocial, ruc, direccion) {
            let valido = true;
            limpiarErrores();
            
            if (!razonSocial || razonSocial.trim() === '') {
                mostrarError('razon-social', 'La razón social es obligatoria');
                valido = false;
            }
            
            if (!ruc || ruc.trim() === '') {
                mostrarError('ruc', 'El RUC es obligatorio');
                valido = false;
            } else if (!/^\d{11}$/.test(ruc)) {
                mostrarError('ruc', 'El RUC debe tener 11 dígitos');
                valido = false;
            }
            
            if (!direccion || direccion.trim() === '') {
                mostrarError('direccion', 'La dirección es obligatoria');
                valido = false;
            }
            
            return valido;
        }

        // Función para generar PDF de la boleta
        async function generarPDFBoleta(id) {
            try {
                const boleta = await db.boletas.get(id);
                if (!boleta) return;

                // Crear nombre de archivo con razón social y fecha
                const fecha = new Date(boleta.fecha);
                const fechaStr = fecha.toLocaleDateString('es-ES').replace(/\//g, '-');
                const nombreArchivo = `Boleta_${boleta.razonSocial.replace(/\s+/g, '_')}_${fechaStr}.pdf`;

                // Crear instancia de jsPDF
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Establecer márgenes
                const marginLeft = 15;
                const marginRight = 15;
                const pageWidth = 210; // Ancho A4 en mm
                const textWidth = pageWidth - marginLeft - marginRight;
                let y = 15;

                // Función para agregar texto con estilo
                function addText(text, x, y, options = {}) {
                    const { fontSize = 12, fontStyle = 'normal', align = 'left' } = options;
                    doc.setFontSize(fontSize);
                    doc.setFont(undefined, fontStyle);
                    doc.text(text, x, y, { align });
                }

                // Encabezado
                doc.setFillColor(26, 58, 95); // Color primario
                doc.rect(0, 0, pageWidth, 30, 'F');
                addText('JC PATH LAB', pageWidth / 2, 12, { fontSize: 20, fontStyle: 'bold', align: 'center' });
                addText('Laboratorio de Anatomía Patológica', pageWidth / 2, 18, { fontSize: 14, align: 'center' });

                y = 40;

                // Título de la boleta
                addText('BOLETA DE VENTA', pageWidth / 2, y, { fontSize: 18, fontStyle: 'bold', align: 'center' });
                y += 15;

                // Información del emisor
                addText('EMISOR:', marginLeft, y, { fontSize: 12, fontStyle: 'bold' });
                y += 7;
                addText('NOMBRE: Josehp Christopher Castillo Cuenca', marginLeft, y);
                y += 5;
                addText('DOCUMENTO: DNI 41457466', marginLeft, y);
                y += 5;
                addText('DIRECCIÓN: MZ M2 LOTE 13 URB. JARDINES DE CHILLON', marginLeft, y);
                y += 5;
                addText('RUC Emisor: 10414574667', marginLeft, y);
                y += 10;

                // Línea separadora
                doc.line(marginLeft, y, pageWidth - marginRight, y);
                y += 10;

                // Información del cliente
                addText('CLIENTE:', marginLeft, y, { fontSize: 14, fontStyle: 'bold' });
                y += 7;
                addText(`Razón Social: ${boleta.razonSocial}`, marginLeft, y);
                y += 5;
                addText(`RUC: ${boleta.ruc}`, marginLeft, y);
                y += 5;
                addText(`Dirección: ${boleta.direccion}`, marginLeft, y);
                y += 5;
                addText(`Número de muestras: ${boleta.numMuestras}`, marginLeft, y);
                y += 10;

                // Detalles de costos
                boleta.montos.forEach((monto, index) => {
                    addText(`Muestra ${index + 1} Costo: S/ ${monto.toFixed(2)}`, marginLeft, y);
                    y += 5;
                });

                y += 5;

                // Total
                addText(`Pago total: S/ ${boleta.total.toFixed(2)}`, marginLeft, y, { fontSize: 14, fontStyle: 'bold' });
                y += 10;

                // Fecha y lugar
                addText(`Puente Piedra, ${formatDate(fecha)}`, pageWidth - marginRight, y, { align: 'right' });

                // Guardar el PDF
                doc.save(nombreArchivo);

            } catch (error) {
                alert('Error al generar el PDF: ' + error);
            }
        }
        
        // Inicialización cuando el DOM está listo
        document.addEventListener('DOMContentLoaded', async function() {
            await initDatabase();
            
            // Configuración inicial
            precargarDatos();
            setupDatabaseListeners();
            setInterval(hacerRespaldoCompleto, 5 * 60 * 1000);
            
            // Navegación
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    if (!this.dataset.section) return;
                    e.preventDefault();
                    showSection(this.dataset.section);
                });
            });
            
            document.getElementById('logoSection').addEventListener('click', () => showSection('inicio'));
            
            // Eventos de formulario de cliente
            document.getElementById('registrar-cliente').addEventListener('click', async function() {
                const razonSocial = document.getElementById('razon-social').value;
                const ruc = document.getElementById('ruc').value;
                const direccion = document.getElementById('direccion').value;
                const telefono = document.getElementById('telefono').value;
                const email = document.getElementById('email').value;
                
                // Validar formulario
                if (!validarFormularioCliente(razonSocial, ruc, direccion)) {
                    return;
                }
                
                try {
                    // Verificar si el RUC ya existe
                    const clienteExistente = await db.clientes.where('ruc').equals(ruc).first();
                    if (clienteExistente) {
                        mostrarError('ruc', 'Ya existe un cliente registrado con este RUC');
                        return;
                    }
                    
                    await db.clientes.add({
                        razonSocial,
                        ruc,
                        direccion,
                        telefono: telefono || '',
                        email: email || '',
                        createdAt: new Date()
                    });
                    
                    // Limpiar formulario
                    ['razon-social', 'ruc', 'direccion', 'telefono', 'email'].forEach(id => {
                        document.getElementById(id).value = '';
                    });
                    
                    alert('Cliente registrado exitosamente');
                    showSection('listado');
                } catch (error) {
                    if (error.name === 'ConstraintError') {
                        mostrarError('ruc', 'Ya existe un cliente registrado con este RUC');
                    } else {
                        alert('Error al registrar cliente: ' + error.message);
                    }
                }
            });
            
            // Eliminar cliente
            document.getElementById('clientes-body').addEventListener('click', async function(e) {
                if (e.target.classList.contains('eliminar-btn')) {
                    const row = e.target.closest('tr');
                    const id = parseInt(row.getAttribute('data-id'));
                    
                    if (confirm('¿Está seguro que desea eliminar este cliente?')) {
                        try {
                            await db.clientes.delete(id);
                        } catch (error) {
                            alert('Error al eliminar cliente: ' + error);
                        }
                    }
                }
            });
            
            // Selección de cliente en plantilla
            document.getElementById('cliente-select').addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                document.getElementById('ruc-cliente').textContent = selectedOption.getAttribute('data-ruc') || '';
                document.getElementById('direccion-cliente').textContent = selectedOption.getAttribute('data-direccion') || '';
            });
            
            // Generar campos de costo dinámicamente
            document.getElementById('num-muestras').addEventListener('change', function() {
                const numMuestras = parseInt(this.value) || 1;
                const container = document.getElementById('costos-container');
                container.innerHTML = '';
                
                for (let i = 1; i <= numMuestras; i++) {
                    const div = document.createElement('div');
                    div.className = 'template-row costo-item';
                    div.innerHTML = `
                        <div class="template-label">Muestra ${i} Costo:</div>
                        <div class="template-value">
                            <input type="number" class="costo-input costo-muestra" min="0', step="0.01" placeholder="S/ 0.00" data-index="${i}">
                        </div>
                    `;
                    container.appendChild(div);
                }
                
                document.querySelectorAll('.costo-muestra').forEach(input => {
                    input.addEventListener('input', calcularTotal);
                });
            });
            
            // Guardar boleta
            document.getElementById('guardar-boleta').addEventListener('click', async function() {
                const clienteSelect = document.getElementById('cliente-select');
                const selectedOption = clienteSelect.options[clienteSelect.selectedIndex];
                
                if (!selectedOption.value) {
                    alert('Por favor seleccione un cliente');
                    return;
                }
                
                const razonSocial = selectedOption.textContent;
                const ruc = selectedOption.getAttribute('data-ruc') || '';
                const direccion = selectedOption.getAttribute('data-direccion') || '';
                const telefono = selectedOption.getAttribute('data-telefono') || '';
                const email = selectedOption.getAttribute('data-email') || '';
                const numMuestras = parseInt(document.getElementById('num-muestras').value) || 1;
                
                // Obtener costos de muestras
                const montos = [];
                let total = 0;
                
                document.querySelectorAll('.costo-muestra').forEach(input => {
                    const monto = parseFloat(input.value) || 0;
                    montos.push(monto);
                    total += monto;
                });
                
                const boletaData = {
                    codigo: generarCodigoBoleta(),
                    razonSocial,
                    ruc,
                    direccion,
                    telefono,
                    email,
                    numMuestras,
                    montos: JSON.stringify(montos), // Convertir a string para enviar
                    total,
                    cancelado: false,
                    fecha: new Date().toISOString(),
                };

                if (await addBoleta(boletaData)) {
                    // Limpiar el formulario
                    document.getElementById('cliente-select').selectedIndex = 0;
                    document.getElementById('ruc-cliente').textContent = '';
                    document.getElementById('direccion-cliente').textContent = '';
                    document.getElementById('num-muestras').value = 1;
                    document.getElementById('num-muestras').dispatchEvent(new Event('change'));
                    document.getElementById('pago-total').textContent = 'S/ 0.00';
                }
            });
            
            // Eventos de boletas
            document.getElementById('boletas-body').addEventListener('change', async function(e) {
                if (e.target.classList.contains('cancelado-checkbox')) {
                    const id = parseInt(e.target.getAttribute('data-id'));
                    const checked = e.target.checked;
                    
                    try {
                        await db.boletas.update(id, { cancelado: checked });
                        const row = e.target.closest('tr');
                        checked ? row.classList.remove('boleta-pending') : row.classList.add('boleta-pending');
                    } catch (error) {
                        console.error('Error al actualizar estado de boleta:', error);
                    }
                }
            });
            
            document.getElementById('boletas-body').addEventListener('click', async function(e) {
                // Eliminar boleta
                if (e.target.classList.contains('delete-boleta') || e.target.closest('.delete-boleta')) {
                    const btn = e.target.classList.contains('delete-boleta') ? e.target : e.target.closest('.delete-boleta');
                    const id = parseInt(btn.getAttribute('data-id'));
                    
                    if (confirm('¿Está seguro que desea eliminar esta boleta? Esta acción no se puede deshacer.')) {
                        try {
                            await db.boletas.delete(id);
                        } catch (error) {
                            alert('Error al eliminar boleta: ' + error);
                        }
                    }
                }
                
                // Generar PDF de boleta
                if (e.target.classList.contains('print-boleta') || e.target.closest('.print-boleta')) {
                    const btn = e.target.classList.contains('print-boleta') ? e.target : e.target.closest('.print-boleta');
                    const id = parseInt(btn.getAttribute('data-id'));
                    generarPDFBoleta(id);
                }
            });
            
            // Paginación
            document.getElementById('prev-clientes').addEventListener('click', async function() {
                if (currentClientPage > 1) {
                    currentClientPage--;
                    await renderClientesTable();
                }
            });
            
            document.getElementById('next-clientes').addEventListener('click', async function() {
                const count = await db.clientes.count();
                const totalPages = Math.ceil(count / PAGE_SIZE);
                
                if (currentClientPage < totalPages) {
                    currentClientPage++;
                    await renderClientesTable();
                }
            });
            
            document.getElementById('prev-boletas').addEventListener('click', async function() {
                if (currentBoletaPage > 1) {
                    currentBoletaPage--;
                    await renderBoletasTable();
                }
            });
            
            document.getElementById('next-boletas').addEventListener('click', async function() {
                const count = await db.boletas.count();
                const totalPages = Math.ceil(count / PAGE_SIZE);
                
                if (currentBoletaPage < totalPages) {
                    currentBoletaPage++;
                    await renderBoletasTable();
                }
            });
            
            // Inicializar campos de costo
            document.getElementById('num-muestras').dispatchEvent(new Event('change'));
            
            // Actualizar fecha actual
            const dateElement = document.getElementById('current-date');
            if (dateElement) {
                dateElement.textContent = formatDate(new Date());
            }
            
            // Mostrar sección de inicio por defecto
            showSection('inicio');
        });
    </script>
</body>
</html>