<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listado de Clientes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Listado de Clientes</h1>
            <button class="btn btn-secondary" onclick="cargarClientes()">Refrescar Lista</button>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Razón Social</th>
                        <th>RUC</th>
                        <th>Dirección</th>
                        <th>Teléfono</th>
                        <th>Email</th>
                        <th style="width: 150px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="clientes-tbody"></tbody>
            </table>
        </div>
        <div id="status" class="mt-3"></div>
    </div>

    <!-- Modal de Edición -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Editar Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-form">
                        <input type="hidden" id="edit-rowIndex" name="rowIndex">
                        <div class="mb-3">
                            <label for="edit-razon-social" class="form-label">Razón Social</label>
                            <input type="text" class="form-control" id="edit-razon-social" name="Razón Social" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-ruc" class="form-label">RUC</label>
                            <input type="text" class="form-control" id="edit-ruc" name="RUC" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-direccion" class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="edit-direccion" name="Dirección">
                        </div>
                        <div class="mb-3">
                            <label for="edit-telefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="edit-telefono" name="Teléfono">
                        </div>
                        <div class="mb-3">
                            <label for="edit-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit-email" name="Email">
                        </div>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwmXJ46t5J8uekIWPEFhRJWVG6-b0pzsQZ1f0qOW0Fd-K7eBlbq7pQBn8yVlj4qUhj-qw/exec';
        const tbody = document.getElementById('clientes-tbody');
        const statusDiv = document.getElementById('status');
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        const editForm = document.getElementById('edit-form');

        // --- LÓGICA DE EDICIÓN ---
        function abrirModalEdicion(cliente) {
            editForm.elements['rowIndex'].value = cliente.rowIndex;
            editForm.elements['Razón Social'].value = cliente['Razón Social'] || '';
            editForm.elements['RUC'].value = cliente['RUC'] || '';
            editForm.elements['Dirección'].value = cliente['Dirección'] || '';
            editForm.elements['Teléfono'].value = cliente['Teléfono'] || '';
            editForm.elements['Email'].value = cliente['Email'] || '';
            editModal.show();
        }

        editForm.addEventListener('submit', e => {
            e.preventDefault();
            statusDiv.innerHTML = '<div class="alert alert-info">Guardando cambios...</div>';
            
            const formData = new FormData(editForm);
            formData.append('action', 'update');

            fetch(scriptURL, { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => {
                    if (data.result === 'success') {
                        statusDiv.innerHTML = '<div class="alert alert-success">Cliente actualizado correctamente.</div>';
                        editModal.hide();
                        cargarClientes();
                    } else {
                        throw new Error(data.error ? data.error.message : 'Error desconocido al actualizar.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
                });
        });

        // --- CÓDIGOS ANTERIORES (con modificaciones) ---
        function eliminarCliente(rowIndex) {
            if (!confirm(`¿Estás seguro de que quieres eliminar este cliente?`)) return;
            statusDiv.innerHTML = '<div class="alert alert-info">Eliminando...</div>';
            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('rowIndex', rowIndex);
            fetch(scriptURL, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    if (data.result === 'success') {
                        statusDiv.innerHTML = '<div class="alert alert-success">Cliente eliminado.</div>';
                        cargarClientes();
                    } else { throw new Error(data.error ? data.error.message : 'Error'); }
                })
                .catch(error => {
                    statusDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
                });
        }

        function cargarClientes() {
            statusDiv.innerHTML = '<div class="alert alert-info">Cargando...</div>';
            tbody.innerHTML = '';
            fetch(scriptURL)
                .then(res => res.json())
                .then(data => {
                    statusDiv.innerHTML = '';
                    if (data.error) { throw new Error(data.error.message); }
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay clientes.</td></tr>';
                        return;
                    }
                    data.forEach(cliente => {
                        const tr = document.createElement('tr');
                        const clienteDataString = JSON.stringify(cliente).replace(/'/g, "&apos;");
                        tr.innerHTML = `
                            <td>${cliente['Razón Social'] || ''}</td>
                            <td>${cliente['RUC'] || ''}</td>
                            <td>${cliente['Dirección'] || ''}</td>
                            <td>${cliente['Teléfono'] || ''}</td>
                            <td>${cliente['Email'] || ''}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick='abrirModalEdicion(${clienteDataString})'>Editar</button>
                                <button class="btn btn-danger btn-sm" onclick="eliminarCliente(${cliente.rowIndex})">Eliminar</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                })
                .catch(error => {
                    statusDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
                });
        }

        document.addEventListener('DOMContentLoaded', cargarClientes);
    </script>
</body>
</html>
