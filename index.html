<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso - Sistema de Gestión de Boletas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Agregar Dexie.js para IndexedDB -->
    <script src="https://unpkg.com/dexie@3.2.2/dist/dexie.js"></script>
    <style>
        /* ESTILOS EXISTENTES (NO MODIFICADOS) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #2c497e;
            --secondary-color: #3a6ea5;
            --accent-color: #4b8fcc;
            --light-color: #f0f7ff;
            --dark-color: #1a2a4a;
            --gray-color: #6c757d;
            --success-color: #28a745;
            --error-color: #dc3545;
        }

        body {
            background: linear-gradient(135deg, #e6f0ff, #f8fbff);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .left-panel {
            flex: 1;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 60px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .left-panel::before {
            content: "";
            position: absolute;
            top: -50px;
            right: -50px;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
        }

        .left-panel::after {
            content: "";
            position: absolute;
            bottom: -80px;
            left: -30px;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.07);
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 40px;
        }

        .logo-icon {
            font-size: 40px;
            margin-right: 15px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .welcome-title {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .welcome-text {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 30px;
            opacity: 0.9;
            max-width: 500px;
        }

        .features {
            margin-top: 40px;
        }

        .feature {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .feature i {
            font-size: 24px;
            margin-right: 15px;
            color: var(--accent-color);
        }

        .feature-text {
            font-size: 16px;
        }

        .right-panel {
            flex: 1;
            padding: 60px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .login-container {
            max-width: 450px;
            width: 100%;
            margin: 0 auto;
        }

        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 40px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
            font-size: 18px;
        }

        .form-control {
            width: 100%;
            padding: 15px 15px 15px 50px;
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: #fafcff;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(75, 143, 204, 0.2);
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
            cursor: pointer;
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: linear-gradient(to right, var(--secondary-color), var(--accent-color));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 73, 126, 0.3);
        }

        .error-message {
            color: var(--error-color);
            text-align: center;
            margin-top: 15px;
            font-size: 15px;
            height: 20px;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            color: var(--gray-color);
            font-size: 14px;
        }

        .copyright {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eaeaea;
        }

        .access-message {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 40px;
            text-align: center;
            z-index: 10;
            transform: translateY(-100%);
            transition: transform 0.5s ease;
        }

        .access-message.active {
            transform: translateY(0);
        }

        .access-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: #a8e6cf;
        }

        .access-title {
            font-size: 36px;
            margin-bottom: 20px;
        }

        .access-text {
            font-size: 18px;
            max-width: 600px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .continue-btn {
            padding: 12px 30px;
            background: white;
            color: var(--primary-color);
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .continue-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
        }

        /* Nuevos estilos para el panel de administración */
        .admin-container {
            display: flex;
            width: 100%;
            min-height: 100%;
        }

        .user-list-panel {
            flex: 1;
            padding: 40px;
            background: #f8fbff;
            border-right: 1px solid #e1e5eb;
        }

        .user-list-title {
            font-size: 24px;
            color: var(--dark-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--accent-color);
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .user-table th {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
            padding: 15px 20px;
            font-weight: 600;
        }

        .user-table td {
            padding: 15px 20px;
            border-bottom: 1px solid #eaeaea;
            color: var(--dark-color);
        }

        .user-table tr:last-child td {
            border-bottom: none;
        }

        .user-table tr:hover {
            background-color: #f0f7ff;
        }

        .last-login {
            color: var(--gray-color);
            font-size: 14px;
        }

        .admin-actions-panel {
            width: 320px;
            padding: 40px;
            background: white;
        }

        .actions-title {
            font-size: 24px;
            color: var(--dark-color);
            margin-bottom: 25px;
            text-align: center;
        }

        .action-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e5eb;
        }

        .action-btn {
            display: block;
            width: 100%;
            padding: 16px;
            margin-bottom: 15px;
            text-align: center;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: linear-gradient(to right, var(--secondary-color), var(--accent-color));
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(44, 73, 126, 0.3);
        }

        .action-btn.logout {
            background: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            margin-top: 25px;
        }

        .action-btn.logout:hover {
            background: #f0f7ff;
        }

        .admin-only {
            position: relative;
        }

        .admin-only::after {
            content: "Solo Admin";
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--accent-color);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 10px;
            transform: rotate(5deg);
        }

        .user-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background-color: var(--success-color);
        }

        .status-inactive {
            background-color: var(--error-color);
        }

        /* Estilos para el botón de eliminar */
        .delete-btn {
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            font-size: 14px;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(220, 53, 69, 0.25);
        }

        .delete-btn i {
            margin-right: 5px;
        }

        .action-cell {
            text-align: center;
        }

        /* Nuevos estilos para paginación */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 10px 0;
        }

        .pagination-btn {
            padding: 8px 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .pagination-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .page-info {
            color: var(--gray-color);
            font-size: 14px;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
                max-width: 700px;
            }
            
            .left-panel {
                padding: 40px 30px;
            }
            
            .right-panel {
                padding: 40px 30px;
            }

            .admin-container {
                flex-direction: column;
            }

            .user-list-panel {
                border-right: none;
                border-bottom: 1px solid #e1e5eb;
            }

            .admin-actions-panel {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .welcome-title {
                font-size: 30px;
            }
            
            .welcome-text {
                font-size: 16px;
            }
            
            .login-title {
                font-size: 24px;
            }

            .access-title {
                font-size: 28px;
            }

            .user-list-panel,
            .admin-actions-panel {
                padding: 30px;
            }

            .user-table th,
            .user-table td {
                padding: 12px 15px;
            }
        }

        @media (max-width: 576px) {
            body {
                padding: 15px;
                background: white;
            }
            
            .container {
                box-shadow: none;
                border-radius: 10px;
            }
            
            .left-panel, .right-panel {
                padding: 30px 20px;
            }
            
            .logo {
                margin-bottom: 30px;
            }
            
            .logo-icon {
                font-size: 32px;
            }
            
            .logo-text {
                font-size: 20px;
            }
            
            .welcome-title {
                font-size: 26px;
            }
            
            .login-title {
                font-size: 22px;
                margin-bottom: 30px;
            }
            
            .form-control {
                padding: 12px 12px 12px 45px;
                font-size: 15px;
            }
            
            .input-icon {
                font-size: 16px;
            }
            
            .login-btn {
                padding: 14px;
                font-size: 16px;
            }
            
            .feature i {
                font-size: 20px;
            }
            
            .feature-text {
                font-size: 14px;
            }

            .access-title {
                font-size: 24px;
            }

            .access-icon {
                font-size: 50px;
            }

            .user-list-panel,
            .admin-actions-panel {
                padding: 25px 20px;
            }

            .user-table th,
            .user-table td {
                padding: 10px 12px;
            }

            .delete-btn {
                padding: 6px 10px;
                font-size: 13px;
            }
        }

        @media (max-width: 400px) {
            .logo {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .logo-icon {
                margin-bottom: 10px;
            }
            
            .welcome-title {
                font-size: 24px;
            }

            .access-title {
                font-size: 22px;
            }
            
            .user-table th:nth-child(3),
            .user-table td:nth-child(3) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="access-message" id="accessMessage">
            <i class="fas fa-check-circle access-icon"></i>
            <h2 class="access-title">¡Acceso Concedido!</h2>
            <p class="access-text">Bienvenido al sistema, José Castillo. Sus credenciales han sido validadas correctamente. Ahora será redirigido al panel de gestión de boletas.</p>
            <button class="continue-btn" id="continueBtn">Continuar al sistema</button>
        </div>
        
        <div class="left-panel">
            <div class="logo">
                <i class="fas fa-file-invoice-dollar logo-icon"></i>
                <div class="logo-text">SISTEMA DE GESTIÓN DE BOLETAS</div>
            </div>
            <h1 class="welcome-title">Sistema de Gestión de Boletas</h1>
            <p class="welcome-text">Acceda a nuestra plataforma segura para gestionar boletas, ver informes y colaborar con el equipo administrativo.</p>
            
            <div class="features">
                <div class="feature">
                    <i class="fas fa-shield-alt"></i>
                    <div class="feature-text">Plataforma segura y confiable</div>
                </div>
                <div class="feature">
                    <i class="fas fa-file-invoice"></i>
                    <div class="feature-text">Gestión completa de boletas y facturas</div>
                </div>
                <div class="feature">
                    <i class="fas fa-sync-alt"></i>
                    <div class="feature-text">Sincronización en tiempo real</div>
                </div>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="login-container">
                <h2 class="login-title">Acceso al Sistema</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" class="form-control" id="username" placeholder="Usuario" required>
                    </div>
                    
                    <div class="form-group">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" class="form-control" id="password" placeholder="Contraseña" required>
                        <i class="fas fa-eye password-toggle" id="togglePassword"></i>
                    </div>
                    
                    <button type="submit" class="login-btn">Iniciar Sesión</button>
                    <div class="error-message" id="errorMessage"></div>
                </form>
                
                <div class="footer">
                    <div class="copyright">
                        &copy; 2023 Sistema de Gestión de Boletas. Todos los derechos reservados.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Administración (inicialmente oculto) -->
    <div id="adminPanel" class="container" style="display: none;">
        <div class="admin-container">
            <div class="user-list-panel">
                <h2 class="user-list-title">Usuarios del Sistema</h2>
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Permisos</th>
                            <th>Último Acceso</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="userList">
                        <!-- Los usuarios se cargarán dinámicamente -->
                    </tbody>
                </table>
                <!-- Controles de paginación -->
                <div class="pagination-controls">
                    <button id="prevPageBtn" class="pagination-btn" disabled>Anterior</button>
                    <span class="page-info" id="pageInfo">Página 1 de 1</span>
                    <button id="nextPageBtn" class="pagination-btn" disabled>Siguiente</button>
                </div>
            </div>
            
            <div class="admin-actions-panel">
                <h2 class="actions-title">Acciones</h2>
                <div class="action-card">
                    <button id="proceedBtn" class="action-btn">Ir a Boletas</button>
                    <button id="changeCredentialsBtn" class="action-btn admin-only">Cambiar Usuario y Clave</button>
                    <button id="createUserBtn" class="action-btn">Crear Usuario Nuevo</button>
                    <button id="logoutAdminBtn" class="action-btn logout">Cerrar Sesión</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // INICIALIZACIÓN MEJORADA DE INDEXEDDB CON DEXIE.JS
        // =============================================
        let db;
        
        // Función mejorada para inicializar la base de datos
        async function initializeDatabase() {
            try {
                db = new Dexie('BoletasDB');
                
                // Definición de esquema con versionado
                db.version(2).stores({
                    users: '&username, password, lastLogin, status, permissions, createdAt'
                });
                
                // Abrir la base de datos
                await db.open();
                console.log("Base de datos abierta correctamente");
                
                // Solicitar persistencia de almacenamiento
                await requestPersistence();
                
                return true;
            } catch (error) {
                console.error("Error inicializando la base de datos:", error);
                
                // Intentar recuperación en caso de error
                try {
                    // Verificar si la base de datos existe y puede ser abierta
                    const dbNames = await Dexie.getDatabaseNames();
                    if (dbNames.includes('BoletasDB')) {
                        db = new Dexie('BoletasDB');
                        await db.open();
                        console.log("Base de datos recuperada después de error");
                        return true;
                    }
                } catch (recoveryError) {
                    console.error("Error en recuperación:", recoveryError);
                }
                
                return false;
            }
        }

        // Solicitar persistencia de almacenamiento al navegador
        async function requestPersistence() {
            if (navigator.storage && navigator.storage.persist) {
                try {
                    const persisted = await navigator.storage.persist();
                    if (persisted) {
                        console.log("Persistencia de almacenamiento concedida");
                    } else {
                        console.log("Persistencia de almacenamiento no concedida");
                    }
                } catch (error) {
                    console.error("Error solicitando persistencia:", error);
                }
            }
            
            // Verificar el estado de persistencia actual
            if (navigator.storage && navigator.storage.persisted) {
                try {
                    const isPersisted = await navigator.storage.persisted();
                    console.log("El almacenamiento ya es persistente:", isPersisted);
                } catch (error) {
                    console.error("Error verificando persistencia:", error);
                }
            }
        }

        // Precarga de datos críticos - ahora con respaldo en localStorage
        async function preloadCriticalData() {
            try {
                // Verificar primero si la base de datos está inicializada
                if (!db || !db.isOpen()) {
                    const initialized = await initializeDatabase();
                    if (!initialized) {
                        throw new Error("No se pudo inicializar la base de datos");
                    }
                }
                
                // Solo crear el usuario admin si no existe
                const adminExists = await db.users.get("josehpcastillo");
                if (!adminExists) {
                    const hashedPassword = await hashPassword("41457466");
                    await db.users.add({
                        username: "josehpcastillo",
                        password: hashedPassword,
                        lastLogin: new Date().toLocaleString(),
                        status: "active",
                        permissions: "admin",
                        createdAt: new Date().getTime()
                    });
                    console.log("Usuario admin creado");
                    
                    // Crear respaldo en localStorage de la existencia del admin
                    localStorage.setItem('adminUserExists', 'true');
                } else {
                    console.log("Usuario admin ya existe");
                    
                    // Actualizar respaldo en localStorage
                    localStorage.setItem('adminUserExists', 'true');
                }
                
                return true;
            } catch (error) {
                console.error("Error en precarga de datos:", error);
                
                // Intentar recuperar desde localStorage si es posible
                if (localStorage.getItem('adminUserExists') === 'true') {
                    console.log("Datos críticos existen según localStorage");
                    return true;
                }
                
                return false;
            }
        }

        // Escuchador de cambios en tiempo real
        function setupDatabaseHooks() {
            if (!db) return;
            
            db.users.hook('creating', function (primKey, obj, transaction) {
                console.log(`Nuevo usuario creado: ${obj.username}`);
                return true;
            });

            db.users.hook('updating', function (modifications, primKey, obj, transaction) {
                console.log(`Usuario actualizado: ${obj.username}`);
                return true;
            });

            db.users.hook('deleting', function (primKey, obj, transaction) {
                console.log(`Usuario eliminado: ${obj.username}`);
                return true;
            });
        }

        // Variables para paginación
        const USERS_PER_PAGE = 10;
        let currentPage = 1;
        let totalPages = 1;
        let totalUsers = 0;

        // Toggle para mostrar/ocultar contraseña
        const togglePassword = document.getElementById('togglePassword');
        const password = document.getElementById('password');
        
        togglePassword.addEventListener('click', function() {
            const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
            password.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });
        
        // Función para hashear contraseña (SHA-256)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // Validación de credenciales
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            
            // Precargar datos críticos antes de la validación
            await preloadCriticalData();
            
            // Credenciales válidas para administrador
            if(username === "josehpcastillo" && password === "41457466") {
                // Ocultar la pantalla de login y mostrar el panel de administración
                document.querySelector('.container').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'flex';
                
                // Cargar lista de usuarios
                await loadUserList();
                
                // Mostrar funcionalidades de administrador
                document.getElementById('changeCredentialsBtn').style.display = 'block';
                return;
            }
            
            try {
                // Buscar usuario en IndexedDB
                const user = await db.users.get(username);
                
                if (user) {
                    // Hashear la contraseña ingresada
                    const hashedPassword = await hashPassword(password);
                    
                    // Comparar con la contraseña almacenada
                    if (hashedPassword === user.password) {
                        // Ocultar la pantalla de login y mostrar el panel de administración
                        document.querySelector('.container').style.display = 'none';
                        document.getElementById('adminPanel').style.display = 'flex';
                        await loadUserList();
                        
                        // Si es administrador, mostrar funcionalidades especiales
                        if(user.permissions === "admin") {
                            document.getElementById('changeCredentialsBtn').style.display = 'block';
                        } else {
                            document.getElementById('changeCredentialsBtn').style.display = 'none';
                        }
                    } else {
                        showError("Credenciales incorrectas. Intente nuevamente.");
                    }
                } else {
                    showError("Usuario no encontrado. Intente nuevamente.");
                }
            } catch (error) {
                console.error("Error en autenticación:", error);
                showError("Error en el sistema. Intente más tarde.");
            }
        });
        
        // Función para mostrar errores
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            document.getElementById('loginForm').classList.add('error-animation');
            setTimeout(() => {
                document.getElementById('loginForm').classList.remove('error-animation');
            }, 500);
        }
        
        // Función para cargar la lista de usuarios con paginación
        async function loadUserList(page = 1) {
            try {
                const userList = document.getElementById('userList');
                userList.innerHTML = '';
                
                // Calcular paginación
                totalUsers = await db.users.count();
                totalPages = Math.ceil(totalUsers / USERS_PER_PAGE);
                currentPage = Math.min(page, totalPages);
                currentPage = Math.max(currentPage, 1);
                
                // Actualizar controles de paginación
                updatePaginationControls();
                
                // Obtener usuarios con paginación
                const users = await db.users.offset((currentPage - 1) * USERS_PER_PAGE)
                                          .limit(USERS_PER_PAGE)
                                          .toArray();
                
                // Agregar usuarios a la tabla
                users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <span class="user-status status-${user.status}"></span>
                            ${user.username}
                        </td>
                        <td>${user.permissions}</td>
                        <td class="last-login">${user.lastLogin || 'Nunca'}</td>
                        <td class="action-cell">
                            <button class="delete-btn" data-user="${user.username}">
                                <i class="fas fa-trash-alt"></i> Eliminar
                            </button>
                        </td>
                    `;
                    userList.appendChild(tr);
                });
                
                // Agregar event listeners a los botones de eliminar
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const username = this.getAttribute('data-user');
                        deleteUser(username, this);
                    });
                });
            } catch (error) {
                console.error("Error cargando usuarios:", error);
            }
        }
        
        // Actualizar controles de paginación
        function updatePaginationControls() {
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');
            
            pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
        }
        
        // Event listeners para paginación
        document.getElementById('prevPageBtn').addEventListener('click', async () => {
            if (currentPage > 1) {
                await loadUserList(currentPage - 1);
            }
        });
        
        document.getElementById('nextPageBtn').addEventListener('click', async () => {
            if (currentPage < totalPages) {
                await loadUserList(currentPage + 1);
            }
        });
        
        // Función para eliminar un usuario
        async function deleteUser(username, button) {
            try {
                // Confirmación visual antes de eliminar
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ¿Seguro?';
                button.style.background = '#ffc107';
                button.style.color = '#343a40';
                
                // Restaurar botón si se cancela
                const restoreButton = setTimeout(() => {
                    button.innerHTML = '<i class="fas fa-trash-alt"></i> Eliminar';
                    button.style.background = '';
                    button.style.color = '';
                }, 3000);
                
                // Confirmar eliminación al hacer clic nuevamente
                button.onclick = async function() {
                    clearTimeout(restoreButton);
                    
                    // Eliminar visualmente la fila
                    const row = button.closest('tr');
                    row.style.opacity = '0.5';
                    row.style.transition = 'opacity 0.3s';
                    
                    // Eliminar de IndexedDB
                    await db.users.delete(username);
                    
                    // Recargar lista de usuarios manteniendo la página actual
                    await loadUserList(currentPage);
                    
                    // Mostrar notificación de éxito
                    const notification = document.createElement('div');
                    notification.textContent = `Usuario "${username}" eliminado correctamente`;
                    notification.style.position = 'fixed';
                    notification.style.bottom = '20px';
                    notification.style.right = '20px';
                    notification.style.backgroundColor = '#28a745';
                    notification.style.color = 'white';
                    notification.style.padding = '15px 25px';
                    notification.style.borderRadius = '8px';
                    notification.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
                    notification.style.zIndex = '1000';
                    notification.style.animation = 'fadeIn 0.3s';
                    document.body.appendChild(notification);
                    
                    // Eliminar notificación después de 3 segundos
                    setTimeout(() => {
                        notification.style.animation = 'fadeOut 0.5s';
                        setTimeout(() => {
                            document.body.removeChild(notification);
                        }, 500);
                    }, 3000);
                };
            } catch (error) {
                console.error("Error eliminando usuario:", error);
                alert("Error eliminando usuario. Intente nuevamente.");
            }
        }
        
        // Botón para proseguir al sistema de boletas
        document.getElementById('proceedBtn').addEventListener('click', function() {
            // Guardar usuario actual en sessionStorage
            const currentUser = {
                username: "josehpcastillo",
                permissions: "admin"
            };
            sessionStorage.setItem('current_user', JSON.stringify(currentUser));
            window.location.href = "boletas.html";
        });
        
        // Botón para cambiar credenciales (solo admin)
        document.getElementById('changeCredentialsBtn').addEventListener('click', function() {
            alert('Función para cambiar credenciales de usuario (solo administrador)');
        });
        
        // Botón para crear nuevo usuario
        document.getElementById('createUserBtn').addEventListener('click', async function() {
            const username = prompt("Ingrese el nombre de usuario:");
            if (!username) return;
            
            // Solicitar contraseña con validación
            let password = '';
            while (true) {
                password = prompt("Ingrese la contraseña (mínimo 6 caracteres):");
                if (!password) return; // Usuario canceló
                
                if (password.length < 6) {
                    alert("La contraseña debe tener al menos 6 caracteres");
                } else {
                    break; // Contraseña válida
                }
            }
            
            try {
                // Hashear y almacenar contraseña
                const hashedPassword = await hashPassword(password);
                
                // Verificar si el usuario ya existe
                const existingUser = await db.users.get(username);
                if (existingUser) {
                    alert("El usuario ya existe");
                    return;
                }
                
                // Crear nuevo usuario con permisos de solo lectura
                const newUser = {
                    username: username,
                    password: hashedPassword,
                    lastLogin: new Date().toLocaleString(),
                    status: "active",
                    permissions: "lectura",
                    createdAt: new Date().getTime()
                };
                
                // Guardar en IndexedDB
                await db.users.add(newUser);
                
                // Recargar lista de usuarios manteniendo la página actual
                await loadUserList(currentPage);
                
                // Mostrar confirmación
                alert(`Usuario "${username}" creado con éxito`);
            } catch (error) {
                console.error("Error creando usuario:", error);
                alert("Error creando usuario. Intente nuevamente.");
            }
        });
        
        // Botón para cerrar sesión en el panel de admin
        document.getElementById('logoutAdminBtn').addEventListener('click', function() {
            document.getElementById('adminPanel').style.display = 'none';
            document.querySelector('.container').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('errorMessage').textContent = '';
        });
        
        // Animación para notificaciones
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(20px); }
            }
            .error-animation {
                animation: shake 0.5s;
            }
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(style);

        // Inicializar la base de datos al cargar la página
        window.addEventListener('load', async function() {
            // Inicializar la base de datos
            await initializeDatabase();
            
            // Configurar hooks de la base de datos
            setupDatabaseHooks();
            
            // Precargar datos críticos
            await preloadCriticalData();
            
            console.log("Sistema inicializado correctamente");
            
            // Verificar regularmente el estado de la base de datos
            setInterval(async () => {
                try {
                    if (!db || !db.isOpen()) {
                        console.warn("Base de datos cerrada, reconectando...");
                        await initializeDatabase();
                        setupDatabaseHooks();
                    }
                } catch (error) {
                    console.error("Error en verificación de estado de BD:", error);
                }
            }, 30000); // Verificar cada 30 segundos
        });
    </script>
</body>
</html>